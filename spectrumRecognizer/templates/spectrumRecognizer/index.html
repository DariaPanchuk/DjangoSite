{% load static %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container mt-5 mb-5">
    <h1 class="mb-4">Spectrum Recognizer</h1>

    <div class="card shadow-sm p-4 mb-4">
        <h5>Завантажити аудіо (MP3, WAV)</h5>
        <form method="post" enctype="multipart/form-data" onsubmit="showLoading()">
            {% csrf_token %}
            <input type="file" name="audio" class="form-control mb-3" accept="audio/*" required>
            <button type="submit" class="btn btn-primary w-100">Аналізувати</button>
        </form>
    </div>

    <hr>

    <div id="loading-spinner" style="display: none;" class="alert alert-info text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-2">Обробка сигналу...</h4>
    </div>

    {% if obj %}
        <div class="card shadow-sm p-3 mb-3">
            <div class="card-title">
                Результат аналізу
            </div>

            <div class="card-body text-center">

                <canvas id="visualizer" style="width: 100%; height: 300px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;"></canvas>

                <p class="text-muted small mt-2">Натисніть Play, щоб побачити живий графік</p>

                <h4 class="mb-3">Назва файлу: {{ obj.title }}</h4>

                <audio id="audioPlayer" controls class="w-100 mb-4" crossorigin="anonymous">
                    <source src="{{ obj.audio.url }}">
                    Ваш браузер не підтримує аудіо.
                </audio>

                <h5 class="text-muted">Виявлені пікові частоти:</h5>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                    {% for item in obj.get_result_list %}
                        <span class="card p-2 text-center bg-light">{{ item }}</span>
                    {% empty %}
                        <span class="text-muted">Даних немає</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
    function showLoading() {
        document.getElementById('loading-spinner').style.display = 'block';
        document.querySelector('button[type="submit"]').disabled = true;
        document.querySelector('button[type="submit"]').innerText = "Обробка...";
    }

    let audioContext, analyser, source;
    let isInitialized = false;
    const audio = document.getElementById('audioPlayer');
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const paddingTop = 20;
    const paddingBottom = 30;
    const paddingLeft = 60;

    function resizeCanvas() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    if (audio) {
        audio.onplay = function() {
            if (!isInitialized) initAudioContext();
            if (audioContext && audioContext.state === 'suspended') audioContext.resume();
        };
    }

    function initAudioContext() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();

        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.85;
        analyser.minDecibels = -120;
        analyser.maxDecibels = 0;

        source = audioContext.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioContext.destination);

        isInitialized = true;
        draw();
    }

    function draw() {
        const drawWidth = canvas.width - paddingLeft;
        const drawHeight = canvas.height - paddingBottom - paddingTop;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const minHz = 10;
        const maxHz = 20000;
        const logMin = Math.log(minHz);
        const logMax = Math.log(maxHz);

        function getFreqFromX(x) {
            const percent = x / drawWidth;
            return Math.exp(logMin + (logMax - logMin) * percent);
        }

        function getBinIndex(freq) {
            return Math.floor(freq * analyser.fftSize / audioContext.sampleRate);
        }

        function renderFrame() {
            requestAnimationFrame(renderFrame);
            analyser.getByteFrequencyData(dataArray);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawGrid(ctx, drawWidth, drawHeight);
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#0d6efd';

            for (let x = 0; x < drawWidth; x++) {
                const freq = getFreqFromX(x);
                const index = getBinIndex(freq);

                let value = 0;
                if (index < bufferLength) {
                    value = dataArray[index];
                }

                const percent = value / 255;
                const y = paddingTop + (drawHeight - (percent * drawHeight));
                const physicalX = x + paddingLeft;

                if (x === 0) ctx.moveTo(physicalX, y);
                else ctx.lineTo(physicalX, y);
            }

            ctx.stroke();
            ctx.clearRect(0, canvas.height - paddingBottom, canvas.width, paddingBottom);
            ctx.clearRect(0, 0, canvas.width, paddingTop - 2);
            drawLabelsOnly(ctx, drawWidth, drawHeight);
        }
        renderFrame();
    }

    function drawGrid(ctx, w, h) {
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#e9ecef';

        const freqs = [10, 20, 30, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
        const minLog = Math.log(10);
        const maxLog = Math.log(20000);

        freqs.forEach((f) => {
            const percent = (Math.log(f) - minLog) / (maxLog - minLog);
            const x = paddingLeft + (percent * w);

            ctx.beginPath();
            ctx.moveTo(x, paddingTop);
            ctx.lineTo(x, paddingTop + h);
            ctx.stroke();
        });

        const dBs = [0, -20, -40, -60, -80, -100, -120];
        dBs.forEach(db => {
            const percent = Math.abs(db) / 120;
            const y = paddingTop + (percent * h);

            ctx.beginPath();
            ctx.moveTo(paddingLeft, y);
            ctx.lineTo(paddingLeft + w, y);
            ctx.stroke();
        });

        ctx.beginPath();
        ctx.strokeStyle = '#dee2e6';
        ctx.moveTo(paddingLeft, paddingTop);
        ctx.lineTo(paddingLeft, paddingTop + h);
        ctx.stroke();
    }

    function drawLabelsOnly(ctx, w, h) {
        ctx.fillStyle = "#6c757d";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "center";

        const freqs = [10, 20, 30, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
        const labels = ["10 Hz", "20 Hz", "30 Hz", "50 Hz", "100 Hz", "200 Hz", "500 Hz", "1k Hz", "2k Hz", "5k Hz", "10k Hz", "20k Hz"];
        const minLog = Math.log(10);
        const maxLog = Math.log(20000);

        freqs.forEach((f, i) => {
            const percent = (Math.log(f) - minLog) / (maxLog - minLog);
            const x = paddingLeft + (percent * w);
            ctx.fillText(labels[i], x, paddingTop + h + 15);
        });

        ctx.textAlign = "right";
        const dBs = [0, -20, -40, -60, -80, -100, -120];
        dBs.forEach(db => {
            const percent = Math.abs(db) / 120;
            const y = paddingTop + (percent * h);
            ctx.fillText(db + " dB", paddingLeft - 5, y + 4);
        });
    }
</script>